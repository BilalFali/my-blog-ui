import React, { useEffect, useState } from 'react';
import { useParams } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Calendar, Clock, Share2, User } from 'lucide-react';
import TagBadge from '../components/TagBadge';
import CodeBlock from '../components/CodeBlock';
import AdBanner from '../components/AdBanner';
import ArticleCard from '../components/ArticleCard';
import type { Article } from '../components/ArticleCard';
import Loader from '../components/Loader';
import { blogApi, type Post } from '../services/api';

// Mock article data
const mockArticle = {
  id: 1,
  title: 'Getting Started with Flutter State Management',
  content: `
Flutter state management is a crucial aspect of building robust and scalable applications. In this comprehensive guide, we'll explore different state management solutions and help you choose the right one for your project.

## Understanding State in Flutter

State represents the data that can change over time in your application. Flutter provides several ways to manage state, from simple setState() to more complex solutions like BLoC, Provider, and Riverpod.

## setState() - The Basics

The simplest form of state management in Flutter is using the setState() method. Here's a basic example:

\`\`\`dart
class CounterWidget extends StatefulWidget {
  @override
  _CounterWidgetState createState() => _CounterWidgetState();
}

class _CounterWidgetState extends State<CounterWidget> {
  int _counter = 0;

  void _incrementCounter() {
    setState(() {
      _counter++;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text('Count: $_counter'),
        ElevatedButton(
          onPressed: _incrementCounter,
          child: Text('Increment'),
        ),
      ],
    );
  }
}
\`\`\`

## Provider Pattern

Provider is one of the most popular state management solutions in Flutter. It's recommended by the Flutter team and offers a good balance between simplicity and power.

\`\`\`dart
class Counter with ChangeNotifier {
  int _count = 0;
  int get count => _count;

  void increment() {
    _count++;
    notifyListeners();
  }
}

// In your widget
Text('Counter value displayed here')
\`\`\`

## BLoC Pattern

BLoC (Business Logic Component) is a more structured approach that separates business logic from UI.

\`\`\`dart
class CounterBloc extends Bloc<CounterEvent, int> {
  CounterBloc() : super(0) {
    on<IncrementEvent>((event, emit) => emit(state + 1));
    on<DecrementEvent>((event, emit) => emit(state - 1));
  }
}
\`\`\`

## Choosing the Right Solution

- **setState()**: Simple, local state
- **Provider**: Medium complexity, app-wide state
- **BLoC**: Complex apps, strict separation of concerns
- **Riverpod**: Modern, compile-safe alternative to Provider

## Conclusion

Choose your state management solution based on your app's complexity and your team's familiarity with the pattern. Start simple and evolve as needed.
`,
  image: 'https://images.unsplash.com/photo-1551650975-87deedd944c3?w=1200&h=600&fit=crop',
  date: '2024-11-01',
  readTime: 8,
  tags: ['Flutter', 'State Management', 'BLoC', 'Provider'],
  language: 'en' as const,
  author: 'Bilal',
};

const relatedArticles: Article[] = [
  {
    id: 2,
    title: 'Building Responsive Layouts in Flutter',
    excerpt: 'Master the art of creating beautiful responsive UIs that work seamlessly across all device sizes.',
    image: 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=800&h=400&fit=crop',
    date: '2024-10-25',
    readTime: 10,
    tags: ['Flutter', 'UI/UX', 'Responsive Design'],
    language: 'en',
    slug: 'building-responsive-layouts-flutter',
  },
  {
    id: 3,
    title: 'Advanced Dart Programming Techniques',
    excerpt: 'Dive deep into advanced Dart features and patterns that will make you a better Flutter developer.',
    image: 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=400&fit=crop',
    date: '2024-10-20',
    readTime: 12,
    tags: ['Dart', 'Flutter', 'Advanced'],
    language: 'en',
    slug: 'advanced-dart-programming',
  },
];

const ArticlePage: React.FC = () => {
  const { slug } = useParams<{ slug: string }>();
  const { t } = useTranslation();
  const [loading] = React.useState(false);

  // In production, fetch article based on slug from API
  // For now, using mock data
  console.log('Loading article:', slug);
  const article = mockArticle;

  if (loading) {
    return <Loader text={t('loading')} />;
  }

  const renderContent = (content: string) => {
    const parts = content.split('```');
    
    return parts.map((part, index) => {
      if (index % 2 === 1) {
        // This is a code block
        const lines = part.split('\n');
        const language = lines[0].trim() || 'javascript';
        const code = lines.slice(1).join('\n');
        return <CodeBlock key={index} code={code} language={language} />;
      } else {
        // This is regular text
        return (
          <div key={index} className="prose dark:prose-dark max-w-none">
            {part.split('\n').map((line, i) => {
              if (line.startsWith('## ')) {
                return <h2 key={i} className="text-2xl font-bold mt-8 mb-4 text-gray-900 dark:text-white">{line.substring(3)}</h2>;
              } else if (line.startsWith('# ')) {
                return <h1 key={i} className="text-3xl font-bold mt-8 mb-4 text-gray-900 dark:text-white">{line.substring(2)}</h1>;
              } else if (line.trim()) {
                return <p key={i} className="mb-4 text-gray-700 dark:text-gray-300 leading-relaxed">{line}</p>;
              }
              return <br key={i} />;
            })}
          </div>
        );
      }
    });
  };

  return (
    <div className="min-h-screen">
      {/* Featured Image */}
      <div className="relative h-96 w-full overflow-hidden">
        <img
          src={article.image}
          alt={article.title}
          className="w-full h-full object-cover"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
      </div>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 -mt-32 relative z-10">
        <article className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden">
          <div className="p-8 md:p-12">
            {/* Article Header */}
            <div className="mb-8">
              <div className="flex flex-wrap gap-2 mb-4">
                {article.tags.map((tag) => (
                  <TagBadge key={tag} tag={tag} variant="primary" size="md" />
                ))}
              </div>

              <h1 className="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-6">
                {article.title}
              </h1>

              <div className="flex flex-wrap items-center gap-6 text-gray-600 dark:text-gray-400">
                <span className="flex items-center gap-2">
                  <Calendar className="w-5 h-5" />
                  {new Date(article.date).toLocaleDateString()}
                </span>
                <span className="flex items-center gap-2">
                  <Clock className="w-5 h-5" />
                  {article.readTime} {t('minuteRead')}
                </span>
                <span>By {article.author}</span>
              </div>
            </div>

            <hr className="border-gray-200 dark:border-gray-700 mb-8" />

            {/* Ad Banner */}
            <AdBanner className="mb-8 h-24" />

            {/* Article Content */}
            <div className="article-content">
              {renderContent(article.content)}
            </div>

            {/* Ad Banner */}
            <AdBanner className="my-8 h-24" />

            {/* Share Section */}
            <div className="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
              <button className="flex items-center gap-2 px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
                <Share2 className="w-5 h-5" />
                {t('shareArticle')}
              </button>
            </div>
          </div>
        </article>

        {/* Related Posts */}
        <div className="mt-16 mb-16">
          <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-8">
            {t('relatedPosts')}
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {relatedArticles.map((article) => (
              <ArticleCard key={article.id} article={article} />
            ))}
          </div>
        </div>

        {/* Bottom Ad */}
        <AdBanner className="mb-16 h-32" />
      </div>
    </div>
  );
};

export default ArticlePage;
